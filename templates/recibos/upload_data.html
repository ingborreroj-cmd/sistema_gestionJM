{% extends "recibos/base.html" %}

{% block page_title %}{{ title }}{% endblock %}

{% block sub_title %}
<p class="text-sm text-gray-500">{{ sub_title }}</p>
{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto">
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-100">

        <!-- 1. Mensajes del Sistema (Django Messages) -->
        {% if messages %}
        <div class="mb-6 space-y-3">
            {% for message in messages %}
            {% if "success" in message.tags %}
            <div class="p-4 rounded-lg bg-green-50 border border-green-200 text-green-700 shadow-sm" role="alert">
                <p class="font-medium flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    ¡Carga Exitosa!
                </p>
                <p class="mt-1 text-sm">{{ message }}</p>
            </div>
            {% elif "error" in message.tags %}
            <div class="p-4 rounded-lg bg-red-50 border border-red-200 text-red-700 shadow-sm" role="alert">
                <p class="font-medium flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Error de Carga
                </p>
                <p class="mt-1 text-sm">{{ message }}</p>
            </div>
            {% else %}
            <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-blue-700 shadow-sm" role="alert">
                <p class="mt-1 text-sm">{{ message }}</p>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        
        <!-- 2. Formulario de Carga -->
        <form method="POST" enctype="multipart/form-data" action="" class="space-y-8">
            {% csrf_token %}
            
            <!-- Campo de Formulario de Archivo -->
            <div>
                <label for="{{ form.file.id_for_label }}" class="block text-lg font-semibold text-gray-800 mb-3">
                    {{ form.file.label }}
                </label>
                
                <!-- Contenedor del Dropzone -->
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl transition duration-150 ease-in-out hover:border-indigo-400 hover:bg-indigo-50" id="file-drop-area">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-8m12 4h.01M30 14l-5 5-5-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="flex text-sm text-gray-600 justify-center">
                            <!-- El widget de archivo de Django se renderiza aquí -->
                            {{ form.file }} 
                        </div>
                        <p class="text-xs text-gray-500" id="file-name-display">
                            {{ form.file.help_text|default:"Selecciona o arrastra un archivo XLSX o XLS." }}
                        </p>
                    </div>
                </div>
                
                {% for error in form.file.errors %}
                    <p class="text-sm text-red-600 mt-2 font-medium">{{ error }}</p>
                {% endfor %}
            </div>

            <!-- Instrucciones de Formato -->
            <div class="p-4 border border-indigo-200 bg-indigo-50 rounded-xl">
                <h4 class="text-lg font-bold text-indigo-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Guía de Columnas
                </h4>
                <p class="text-sm text-indigo-700">
                    Asegúrate de que la primera fila del archivo Excel tenga los siguientes encabezados (o su equivalente) para un mapeo correcto:
                </p>
                <div class="mt-3 text-xs font-mono bg-indigo-100 p-2 rounded-lg break-words text-indigo-900">
                    Número Recibo, Fecha Pago, Cédula/RIF, Nombre Cliente, Monto (Bs), Categoria 1, Categoria 2, ...
                </div>
            </div>
            
            <!-- Botón de Envío -->
            <div class="pt-6 border-t border-gray-100">
                <div class="flex justify-end">
                    <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-semibold rounded-lg shadow-lg text-white bg-green-600 hover:bg-green-700 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Procesar y Cargar Recibos
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputFile = document.getElementById('{{ form.file.id_for_label }}');
    const fileNameDisplay = document.getElementById('file-name-display');
    const dropArea = document.getElementById('file-drop-area');

    // 1. Mostrar nombre de archivo seleccionado y aplicar estilos de éxito
    if (inputFile) {
        inputFile.classList.add('absolute', 'inset-0', 'w-full', 'h-full', 'opacity-0', 'cursor-pointer'); // Estilos para hacer invisible el input, manteniendo la funcionalidad

        inputFile.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                const fileName = this.files[0].name;
                fileNameDisplay.textContent = 'Archivo seleccionado: ' + fileName;
                dropArea.classList.add('border-green-400', 'bg-green-50');
                dropArea.classList.remove('border-gray-300', 'hover:border-indigo-400', 'hover:bg-indigo-50');
            } else {
                fileNameDisplay.textContent = '{{ form.file.help_text|default:"Selecciona o arrastra un archivo XLSX o XLS." }}';
                dropArea.classList.remove('border-green-400', 'bg-green-50');
                dropArea.classList.add('border-gray-300', 'hover:border-indigo-400', 'hover:bg-indigo-50');
            }
        });

        // 2. Manejar Drag and Drop para la zona de soltar (Dropzone)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Resaltar área al arrastrar (Hover visual)
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('border-indigo-500', 'bg-indigo-100');
        }

        function unhighlight() {
            dropArea.classList.remove('border-indigo-500', 'bg-indigo-100');
        }

        // Manejar el evento de soltar
        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            unhighlight(e);
            let dt = e.dataTransfer;
            let files = dt.files;

            // Asignar los archivos al input
            if (files.length > 0) {
                // Creamos un nuevo DataTransfer para asignar los archivos al input (compatible con navegadores)
                const dataTransfer = new DataTransfer();
                for (let i = 0; i < files.length; i++) {
                    // Solo acepta el primer archivo en un escenario de drop múltiple
                    if (i === 0) {
                        dataTransfer.items.add(files[i]);
                    }
                }
                inputFile.files = dataTransfer.files;
                
                // Disparar el evento change para actualizar el display
                inputFile.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    }
});
</script>

{% endblock %}